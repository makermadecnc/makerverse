#!/bin/bash

# https://github.com/drud/ddev/issues/2772
if [ $BUILDKITE_AGENT_META_DATA_ARCH == "arm64v8" ]; then
  export BUILDAH_OS="Raspbian"
elif [ $BUILDKITE_AGENT_META_DATA_ARCH == "arm32v7" ]; then
  export BUILDAH_OS="Raspbian"
else
  export BUILDAH_OS="xUbuntu"
fi

# install buildah
if [ ! $(which buildah) ]; then
  apt-get update -y
  apt-get install -y curl gpg

  . /etc/os-release
  sh -c "echo 'deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/${BUILDAH_OS}_${VERSION_ID}/ /' > /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list"
  curl -L https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable/${BUILDAH_OS}_${VERSION_ID}/Release.key | apt-key add

  apt-get update
  apt-get -y install buildah
fi

# Infer the real branch from CI env
if [ $BUILDKITE_PULL_REQUEST != "false" ]; then
  # Pull requests always build as the "beta" branch.
  export DOCKER_BUILD_TAG="beta"
elif [ $BUILDKITE_BRANCH != "master" ]; then
  # Non-master branch builds are always "alpha".
  export DOCKER_BUILD_TAG="alpha"
else
  # Full production build, tagged latest.
  export DOCKER_BUILD_TAG="latest"
fi

export DOCKER_USER="inzania"
export PRODUCT_NAME="makerverse"
export DOCKER_ORG="makerverse"
export DOCKER_IMAGE="core"
export DOCKER_REPO="$DOCKER_ORG/$DOCKER_IMAGE"

export NPM_LOCAL_REGISTRY="https://npm.oodalolly.camp"
export DOCKER_LOCAL_REGISTRY="containers.oodalolly.camp"
export DOCKER_PUBLIC_REGISTRY="docker.io"
